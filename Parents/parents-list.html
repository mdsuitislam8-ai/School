<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï ‡¶§‡¶•‡ßç‡¶Ø - ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° (‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    
    <style>
        /* (The CSS styles remain the same as the previous version for responsiveness) */
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; }
        .name-cell { min-width: 200px; }
        .contact-cell { min-width: 250px; }
        .action-icon { cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s; }
        .action-icon:hover { opacity: 0.8; background-color: #fff0f0; }
        @media (max-width: 640px) {
            .data-table-wrapper { min-width: 800px; }
            .px-6 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
            .py-4 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">

<div class="max-w-full lg:max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-4 sm:p-6 md:p-8">
    <header class="mb-6 pb-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center">
        <h1 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center mb-2 sm:mb-0">
            <i data-lucide="shield-check" class="w-6 h-6 mr-3 text-red-600"></i>
            ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï ‡¶§‡¶•‡ßç‡¶Ø - ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°
        </h1>
        <span class="text-xs sm:text-sm text-gray-500">‡¶Æ‡ßã‡¶ü ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï: <span id="parent-count">...</span></span>
    </header>

    <div class="flex flex-col md:flex-row gap-4 mb-6 items-stretch md:items-end">
        <div class="w-full md:w-64 flex-grow">
            <label for="search-input" class="text-sm font-medium text-gray-700 block mb-1">‡¶ñ‡ßã‡¶Å‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶®‡¶æ‡¶Æ/‡¶´‡ßã‡¶®):</label>
            <input type="text" id="search-input" onkeyup="filterParents()" placeholder="‡¶®‡¶æ‡¶Æ, ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞, ‡¶¨‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm transition duration-150 ease-in-out">
        </div>
        
        <div class="flex space-x-2 w-full md:w-auto">
            <button class="flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-lg shadow-md hover:bg-green-600 transition duration-150" onclick="alert('Excel Export feature requested!')">
                <i data-lucide="file-spreadsheet" class="w-4 h-4 mr-1"></i> Excel Export
            </button>
        </div>
    </div>

    <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
        <div class="data-table-wrapper">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">S/N</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider name-cell">‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider contact-cell">‡¶õ‡¶æ‡¶§‡ßç‡¶∞/‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ (‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ)</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-32">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                    </tr>
                </thead>
                <tbody id="parent-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>

        <div id="loading-message" class="p-8 text-center text-gray-500">‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <div id="no-data-message" class="p-8 text-center text-red-500 font-medium hidden">
            ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§
        </div>
        <div id="error-message" class="p-8 text-center text-red-700 font-medium hidden">
            ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§
        </div>
    </div>
</div>

<div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div id="confirm-modal-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-11/12 transform scale-100 transition-transform duration-300">
        <h3 class="text-xl font-bold text-red-600 border-b pb-2 mb-3 flex items-center">
            <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
        </h3>
        <p id="confirm-message" class="text-gray-700 mb-6"></p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeModal('confirm-modal')" 
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤
            </button>
            <button id="confirm-button" 
                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
        </div>
    </div>
</div>

<div id="action-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    </div>

<script>
    // --- Firebase Configuration ---
    // IMPORTANT: REPLACE with your actual Firebase configuration details.
    const explicitFirebaseConfig = {
      apiKey: "AIzaSyAjoRYAXQa4J43L4oLmHmUoK7ZqMKCdrxI",
      authDomain: "programme-7eb45.firebaseapp.com",
      databaseURL: "https://programme-7eb45-default-rtdb.firebaseio.com",
      projectId: "programme-7eb45",
      storageBucket: "programme-7eb45.firebasestorage.app",
      messagingSenderId: "431090813085",
      appId: "1:431090813085:web:496fc0d8bb5e57af53ec74",
      measurementId: "G-FE49VB7F1B"
    };

    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : explicitFirebaseConfig; 
    const appId = firebaseConfig.projectId; // Using projectId as a fallback for appId
    
    let db;
    let allParents = [];

    const parentTableBody = document.getElementById('parent-table-body');
    const searchInput = document.getElementById('search-input');
    const loadingMessage = document.getElementById('loading-message');
    const noDataMessage = document.getElementById('no-data-message');
    const errorMessage = document.getElementById('error-message');
    const parentCountElement = document.getElementById('parent-count');

    // Firestore Collection Paths
    const getParentCollectionPath = () => `/artifacts/${appId}/public/data/parents`;
    const getStudentCollectionPath = () => `/artifacts/${appId}/public/data/students`; 


    // --- Firebase Initialization & Listener Setup (WITHOUT AUTH) ---
    try {
        const app = firebase.initializeApp(firebaseConfig);
        db = app.firestore();
        
        // Directly start the listener without any authentication step
        startDataListener();
        
    } catch (error) {
        console.error("Firebase Initialization Failed:", error);
        handleError(`‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï‡ßÄ‡¶ï‡¶∞‡¶£ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}`);
    }

    // The rest of the functions (startDataListener, filterParents, renderTable, 
    // showDeleteConfirmation, deleteParentAndUnlinkStudents, handleAction, modals) 
    // are the SAME as the previous, non-anonymous-sign-in version.
    // I will include the main data function here for completeness.

    function startDataListener() {
        if (!db) return;

        const parentsRef = db.collection(getParentCollectionPath());
        
        parentsRef.onSnapshot(snapshot => {
            loadingMessage.classList.add('hidden');
            allParents = [];
            
            if (snapshot.empty) {
                noDataMessage.textContent = "‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
                noDataMessage.classList.remove('hidden');
                parentCountElement.textContent = '0';
                renderTable(); 
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                data.id = doc.id; 
                data.studentCount = data.students ? data.students.length : 0; 
                allParents.push(data);
            });
            
            parentCountElement.textContent = allParents.length;
            filterParents(); 

        }, err => {
            console.error("Firestore Listener Error:", err);
            handleError(`‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶®‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ${err.message}`);
        });
    }
    
    // --- Data Filtering & Rendering (Same as previous version) ---
    function filterParents() {
        const searchText = searchInput.value.toLowerCase().trim();
        let filteredParents = allParents;

        if (searchText) {
            filteredParents = filteredParents.filter(parent => {
                const name = (parent.fullName || parent.fatherName || parent.motherName || '').toLowerCase();
                const phone = (parent.phone || '').toString().toLowerCase();
                const userId = (parent.userId || parent.id || '').toLowerCase();
                
                return name.includes(searchText) || phone.includes(searchText) || userId.includes(searchText);
            });
        }
        
        renderTable(filteredParents);
    }

    function renderTable(parents = []) {
        parentTableBody.innerHTML = '';
        
        if (parents.length === 0) {
            noDataMessage.textContent = "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§";
            noDataMessage.classList.remove('hidden');
            return;
        }

        noDataMessage.classList.add('hidden');

        parents.forEach((parent, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition duration-150';
            
            const fullName = parent.fullName || parent.fatherName || '‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á';
            const userId = parent.userId || parent.id || 'N/A';
            const phone = parent.phone || 'N/A';
            const studentCount = parent.studentCount;

            row.innerHTML = `
                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 name-cell">
                    <div class="font-semibold text-base">${fullName}</div>
                    <div class="text-xs text-gray-500">${parent.relation || '‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${userId}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-bold">${phone}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-medium">
                    ${studentCount} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞/‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ
                    ${studentCount > 0 ? `<i data-lucide="info" class="w-4 h-4 ml-1 text-blue-500 inline-block align-middle cursor-pointer" title="‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®" onclick="showActionModal('‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ', '‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá', 'text-blue-600')"></i>` : ''}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                    <div class="flex justify-center space-x-3">
                        <i data-lucide="eye" 
                            class="action-icon text-blue-500 w-5 h-5" 
                            title="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®"
                            onclick="handleAction('view', '${parent.id}')">
                        </i>
                        <i data-lucide="trash-2" 
                            class="action-icon text-red-500 w-5 h-5" 
                            title="‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®"
                            onclick="handleAction('delete', '${parent.id}', ${studentCount})">
                        </i>
                    </div>
                </td>
            `;
            parentTableBody.appendChild(row);
        });
        
        lucide.createIcons();
    }
    
    // --- Modals and Actions (Same as previous version, included for functionality) ---
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.classList.remove('opacity-100');
        }
    }

    function showActionModal(title, message, color) {
        const modalId = 'action-modal';
        let modal = document.getElementById(modalId);

        modal.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-11/12 transform scale-100 transition-transform duration-300">
                <h3 class="text-xl font-bold ${color} border-b pb-2 mb-3">${title}</h3>
                <p class="text-gray-700 mb-4">${message}</p>
                <button onclick="closeModal('${modalId}')" 
                         class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        `;
        
        setTimeout(() => {
            modal.classList.add('opacity-100');
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }, 10);
    }
    
    function handleError(message) {
        loadingMessage.classList.add('hidden');
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }
    
    function showDeleteConfirmation(parentId, studentCount) {
        const parent = allParents.find(p => p.id === parentId);
        if (!parent) return showActionModal('‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø', '‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'text-red-600');

        const parentName = parent.fullName || parent.fatherName || `‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï ID: ${parentId}`;

        let message = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø **${parentName}**-‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`;
        
        if (studentCount > 0) {
            message += `\n\n‚ö†Ô∏è **‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:** ‡¶è‡¶á ‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ${studentCount} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶è‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶õ‡¶ø‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶¶‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶®‡•§`;
        }
        message += `\n\n**‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßÄ‡¶Ø‡¶º!**`;
        
        const modal = document.getElementById('confirm-modal');
        const confirmButton = document.getElementById('confirm-button');
        document.getElementById('confirm-message').innerHTML = message.replace(/\n/g, '<br>');

        confirmButton.onclick = function() {
            closeModal('confirm-modal');
            deleteParentAndUnlinkStudents(parentId);
        };

        setTimeout(() => {
            modal.classList.add('opacity-100');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            lucide.createIcons();
        }, 10);
    }
    
    async function deleteParentAndUnlinkStudents(parentId) {
        if (!db) return;

        showActionModal('‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ö‡¶≤‡¶õ‡ßá...', '‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...', 'text-blue-600');

        try {
            const batch = db.batch(); 
            const parentRef = db.collection(getParentCollectionPath()).doc(parentId);

            const parentData = allParents.find(p => p.id === parentId);
            const studentsToUnlink = parentData ? parentData.students || [] : [];
            
            studentsToUnlink.forEach(studentId => {
                const studentRef = db.collection(getStudentCollectionPath()).doc(studentId);
                batch.update(studentRef, { parentId: firebase.firestore.FieldValue.delete() });
            });

            batch.delete(parentRef);
            await batch.commit();

            showActionModal('‡¶∏‡¶´‡¶≤! üéâ', `‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ${studentsToUnlink.length} ‡¶ú‡¶® ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶õ‡¶ø‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, 'text-green-600');
            

        } catch (error) {
            console.error("Delete Operation Failed:", error);
            showActionModal('‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø üõë', `‡¶°‡ßá‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø ‡¶∞‡ßÅ‡¶≤‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}`, 'text-red-600');
        }
    }


    function handleAction(actionType, parentId, studentCount) {
        if (actionType === 'view') {
            window.location.href = `parent-details.html?id=${parentId}`; 
        } else if (actionType === 'delete') {
            showDeleteConfirmation(parentId, studentCount);
        } else {
            showActionModal(`‡¶Ö‡¶≠‡¶ø‡¶≠‡¶æ‡¶¨‡¶ï ID: ${parentId}`, 
                            `'${actionType}' ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`, 
                            'text-gray-600');
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
    });

</script>
</body>
</html>