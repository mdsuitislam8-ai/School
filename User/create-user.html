<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ইউজার ম্যানেজমেন্ট - নতুন ইউজার তৈরি</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    
    <style>
        body { 
            font-family: 'Noto Sans Bengali', sans-serif; 
            background-color: #f4f6f9; 
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .page-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            color: #333;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
        }
        .header-session {
            font-size: 0.9rem;
            color: #555;
            font-weight: 400;
        }
        .form-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        .card-header p {
            font-size: 1.1rem;
            font-weight: 500;
            color: #555;
            margin: 0;
        }
        .close-buttons button {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #aaa;
            cursor: pointer;
            margin-left: 10px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #eee;
            border-bottom: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            font-weight: 500;
            color: #555;
        }
        .tab-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .tab-dropdown {
            margin-left: auto;
            border: 1px solid #ccc;
            border-radius: 4px; /* Changed from 8px for screenshot accuracy */
            padding: 5px 10px; /* Adjusted padding */
            background-color: white;
            height: 40px; /* Align height */
            font-size: 1rem;
        }

        .form-section-title {
            text-align: center;
            margin: 30px 0;
            position: relative;
            font-size: 1.2rem;
            font-weight: 500;
            color: #555;
        }
        .form-section-title::before,
        .form-section-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: #ccc;
        }
        .form-section-title::before { left: 0; }
        .form-section-title::after { right: 0; }
        .form-section-title svg {
            vertical-align: middle;
            margin: 0 10px;
            color: #007bff;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        .form-group {
            padding: 0 10px;
            margin-bottom: 20px;
            flex-basis: 33.333%;
            box-sizing: border-box;
        }
        
        /* Ensures the two fields on the second line (screenshot design) take 50% width */
        .form-group:nth-child(4), .form-group:nth-child(5) {
            flex-basis: 50%;
        }
        
        label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #333;
        }
        label .required {
            color: red;
            font-weight: bold;
            margin-left: 2px;
        }
        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="password"],
        input[type="tel"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
            color: #555;
            transition: border-color 0.2s;
            background-color: white;
        }
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="292.4" height="292.4" viewBox="0 0 292.4 292.4"><path fill="%23666" d="M287 78.4L146.2 219.2 5.4 78.4h281.6z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px;
        }
        
        /* File Upload Styling */
        .file-upload-group {
            display: flex;
            align-items: center;
        }
        .file-upload-display {
            flex-grow: 1;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-right: none;
            border-radius: 4px 0 0 4px;
            color: #777;
            background-color: #f8f8f8;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .file-upload-button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-weight: 500;
        }
        .file-info {
            font-size: 0.8rem;
            color: #999;
            margin-top: 5px;
            display: block;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid #eee;
            margin-top: 10px;
        }
        .form-actions button {
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            margin-left: 10px;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .form-actions .prev-btn {
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ccc;
        }
        .form-actions .submit-btn {
            background-color: #007bff;
            color: white;
            border: 1px solid #007bff;
        }
        .form-actions button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .form-group, 
            .form-group:nth-child(4), 
            .form-group:nth-child(5) {
                flex-basis: 50%;
            }
        }
        @media (max-width: 576px) {
            .form-group, 
            .form-group:nth-child(4), 
            .form-group:nth-child(5) {
                flex-basis: 100%;
            }
            .page-container {
                padding: 10px;
            }
            .tab-buttons {
                flex-direction: column;
            }
            .tab-button {
                width: 100%;
                margin-bottom: 5px;
            }
            .tab-dropdown {
                width: 100%;
                margin-left: 0;
            }
            .form-section-title::before,
            .form-section-title::after {
                width: 20%;
            }
            .form-row {
                margin: 0; /* Remove horizontal margin on mobile */
            }
            .form-group {
                padding: 0;
            }
        }
    </style>
</head>
<body>

<div class="page-container">
    <header class="header">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-square text-blue-500 mr-2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            ইউজার ম্যানেজমেন্ট
        </h1>
        <div class="header-session">
            Current Session: <span style="font-weight: 500;">2025-2026</span>
        </div>
        <div class="hidden sm:block">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-down text-gray-500"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
        </div>
    </header>
    
    <div class="form-card">
        <div class="card-header">
            <p>ইউজার যোগ করুন</p>
            <div class="close-buttons">
                <button title="Minimize">&minus;</button>
                <button title="Close">&times;</button>
            </div>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="changeTab('create')">Create New User</button>
            <button class="tab-button" onclick="changeTab('manage')">Manage Users</button>
            

<select id="userTypeMain" onchange="renderSpecificForm(this.value)" class="tab-dropdown">
                <option value="" disabled selected>-- Select User Type --</option>
                <option value="teacher">শিক্ষক (Teacher)</option>
                <option value="accountant">হিসাবরক্ষক (Accountant)</option>
                <option value="admin">অ্যাডমিন (Admin)</option>
                <option value="other_admin">অন্যান্য প্রশাসন (Other Administration)</option>
            </select>
        </div>

        

<form id="userForm" onsubmit="handleFormSubmit(event)">
            <div class="form-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 0 0-8.48-8.48L5.7 10.3c-.63.63-.63 1.65 0 2.28l8.49 8.49a6 6 0 0 0 8.48-8.48z"></path><line x1="12" y1="12" x2="16" y2="16"></line><line x1="8" y1="8" x2="12" y2="12"></line></svg>
                Personal Data
            </div>

            <div id="formFields" class="form-row">
                <!-- Dynamic Fields Load Here -->
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="passport-photo">Upload Passport Photo:</label>
                    <div class="file-upload-group">
                        <span class="file-upload-display" id="file-name-display">No file selected</span>
                        <input type="file" id="passport-photo" name="passport-photo" accept="image/jpeg, image/png" style="display: none;" onchange="document.getElementById('file-name-display').textContent = this.files[0] ? this.files[0].name : 'No file selected'">
                        <button type="button" class="file-upload-button" onclick="document.getElementById('passport-photo').click()">Choose File</button>
                    </div>
                    <span class="file-info">Accepted Images: jpeg, png. Max file size 2Mb</span>
                </div>
            </div>

            <div id="messageBox" class="p-3 mt-4 text-center rounded-lg font-medium hidden"></div>

            <div class="form-actions">
                <button type="button" class="prev-btn" disabled>
                    <span style="margin-right: 5px;">&larr;</span> Previous
                </button>
                <button type="submit" class="submit-btn" id="submitButton" disabled>
                    Submit form
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- Firebase Global Setup ---
    const explicitFirebaseConfig = {
      apiKey: "AIzaSyAjoRYAXQa4J43L4oLmHmUoK7ZqMKCdrxI",
      authDomain: "programme-7eb45.firebaseapp.com",
      databaseURL: "https://programme-7eb45-default-rtdb.firebaseio.com",
      projectId: "programme-7eb45",
      storageBucket: "programme-7eb45.firebasestorage.app",
      messagingSenderId: "431090813085",
      appId: "1:431090813085:web:496fc0d8bb5e57af53ec74",
      measurementId: "G-FE49VB7F1B"
    };

    // Use environment variables if available, otherwise use explicit config
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : explicitFirebaseConfig; 
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
    
    let db, auth;
    let isAuthReady = false;

    // --- Firebase Initialization ---
    try {
        const app = firebase.initializeApp(firebaseConfig);
        db = app.firestore();
        auth = app.auth();
        firebase.firestore.setLogLevel('debug');
        
        auth.onAuthStateChanged(user => {
            if (!user) {
                // Sign in using custom token or anonymously if token is unavailable
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    auth.signInWithCustomToken(__initial_auth_token).catch(() => auth.signInAnonymously());
                } else {
                    auth.signInAnonymously();
                }
            } else {
                isAuthReady = true;
                console.log("Firebase Auth Ready. User ID:", user.uid);
                // Enable submit button if a user type is already selected and auth is ready
                if (document.getElementById('userTypeMain').value) {
                    document.getElementById('submitButton').disabled = false;
                }
            }
        });
        
    } catch (error) {
        console.error("Firebase Initialization Failed:", error);
        showMessage("প্রাথমিকীকরণ ত্রুটি: Firebase লোড হতে ব্যর্থ হয়েছে।", "error");
    }

    const formFieldsDiv = document.getElementById('formFields');
    const userTypeMainSelect = document.getElementById('userTypeMain');
    const submitButton = document.getElementById('submitButton');
    const messageBox = document.getElementById('messageBox');

    // --- Utility Functions ---
    function showMessage(message, type = 'info') {
        messageBox.textContent = message;
        messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
        
        // Tailwind classes for message box styles
        if (type === 'success') {
            messageBox.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            messageBox.classList.add('bg-red-100', 'text-red-800');
        } else {
            messageBox.classList.add('bg-yellow-100', 'text-yellow-800');
        }
        messageBox.classList.remove('hidden');
    }

    // Firestore Collection Path based on user type
    const getCollectionPath = (type) => {
        let collectionName;
        // Grouping Teachers and all Administration types into specific public collections
        switch (type) {
            case 'teacher':
                collectionName = 'teachers';
                break;
            case 'accountant':
            case 'admin':
            case 'other_admin':
                collectionName = 'administrators'; // Group all admin roles under one collection
                break;
            default:
                console.error("Invalid user type");
                return null;
        }
        // Public Data Path for shared information
        return `/artifacts/${appId}/public/data/${collectionName}`;
    };

    // --- Form Field Generation ---
    function generateInput(id, label, type = 'text', required = true, placeholder = '', value = '') {
        const requiredMark = required ? '<span class="required">*</span>' : '';
        return `
            <div class="form-group">
                <label for="${id}">${label}${requiredMark}</label>
                <input type="${type}" id="${id}" name="${id}" placeholder="${placeholder}" ${required ? 'required' : ''} value="${value}">
            </div>
        `;
    }

    function generateSelect(id, label, options, required = true, selectedValue = '') {
        const requiredMark = required ? '<span class="required">*</span>' : '';
        const optionHtml = options.map(opt => 
            `<option value="${opt.value}" ${opt.value === selectedValue ? 'selected' : ''}>${opt.label}</option>`
        ).join('');
        
        return `
            <div class="form-group">
                <label for="${id}">${label}${requiredMark}</label>
                <select id="${id}" name="${id}" ${required ? 'required' : ''}>
                    <option value="" disabled ${!selectedValue ? 'selected' : ''} hidden>নির্বাচন করুন...</option>
                    ${optionHtml}
                </select>
            </div>
        `;
    }

    // --- Render Form Fields based on User Type ---
    function renderSpecificForm(userType) {
        formFieldsDiv.innerHTML = ''; // Clear previous fields
        submitButton.disabled = !isAuthReady || !userType;

        if (!userType) {
            showMessage("অনুগ্রহ করে যোগ করার জন্য ব্যবহারকারীর ধরণ নির্বাচন করুন।", "info");
            return;
        }

        showMessage(`আপনি '${userType === 'teacher' ? 'শিক্ষক' : 'প্রশাসন কর্মী'}' নির্বাচন করেছেন।`, "info");

        let fieldsHtml = '';

        // --- Common Fields (All Admin/Teacher) ---
        // We render a display field to keep the current selection visible in the form
        fieldsHtml += generateSelect('selectUserTypeDisplay', 'Select User:', [
            // Student option is explicitly removed as per user request
            { value: 'teacher', label: 'Teacher' },
            { value: 'accountant', label: 'Accountant' },
            { value: 'admin', label: 'Admin' },
            { value: 'other_admin', label: 'Other Administration' }
        ], true, userType); 
        
        fieldsHtml += generateInput('fullName', 'Full Name:', 'text', true, 'Full Name');
        fieldsHtml += generateInput('phone', 'Phone:', 'tel', true, '+880XXXXXXXXX');
        fieldsHtml += generateInput('email', 'Email address:', 'email', true, 'your@email.com');
        fieldsHtml += generateInput('username', 'Username:', 'text', true, 'Username');
        fieldsHtml += generateInput('password', 'Password:', 'password', true, 'Password'); // Added Password Field
        fieldsHtml += generateInput('dob', 'Date of Birth:', 'date', true); 
        fieldsHtml += generateInput('telephone', 'Telephone (Optional):', 'tel', false, '+880XXXXXXXXX');
        fieldsHtml += generateInput('address', 'Address:', 'text', true, 'Address');
        fieldsHtml += generateSelect('gender', 'Gender:', [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'other', label: 'Other' }
        ], true);
        fieldsHtml += generateSelect('bloodGroup', 'Blood Group:', [
            { value: 'A+', label: 'A+' }, { value: 'A-', label: 'A-' },
            { value: 'B+', label: 'B+' }, { value: 'B-', label: 'B-' },
            { value: 'AB+', label: 'AB+' }, { value: 'AB-', label: 'AB-' },
            { value: 'O+', label: 'O+' }, { value: 'O-', label: 'O-' }
        ], false);
        fieldsHtml += generateSelect('nationality', 'Nationality:', [
            { value: 'Bangladeshi', label: 'Bangladeshi' },
            { value: 'Indian', label: 'Indian' },
            { value: 'Other', label: 'Other' }
        ], true);
        fieldsHtml += generateSelect('state', 'State/Province:', [
            { value: 'Dhaka', label: 'Dhaka' },
            { value: 'Chittagong', label: 'Chittagong' }
        ], true);
        fieldsHtml += generateSelect('district', 'District:', [
            { value: 'Dhaka', label: 'Dhaka' },
            { value: 'Gazipur', label: 'Gazipur' }
        ], true);

        // --- Specific Fields ---
        if (userType === 'teacher') {
            fieldsHtml += generateInput('employeeId', 'Employee ID:', 'text', true, 'e.g., TCH001');
            fieldsHtml += generateInput('doj', 'Date of Joining:', 'date', true);
            fieldsHtml += generateInput('subject', 'Primary Subject:', 'text', true, 'e.g., Bangla, Math');
            fieldsHtml += generateSelect('designation', 'Designation:', [
                { value: 'assistant_teacher', label: 'সহকারী শিক্ষক' },
                { value: 'head_master', label: 'প্রধান শিক্ষক' },
                { value: 'senior_teacher', label: 'বরিষ্ঠ শিক্ষক' }
            ], true);
        } else if (userType === 'accountant' || userType === 'admin' || userType === 'other_admin') {
            fieldsHtml += generateInput('employeeId', 'Employee ID:', 'text', true, 'e.g., ADM001');
            fieldsHtml += generateInput('doj', 'Date of Joining:', 'date', true);
            fieldsHtml += generateInput('department', 'Department:', 'text', true, 'e.g., Accounts, IT');
            // We use the selected 'userType' as the designation, no extra input needed
        }
        
        formFieldsDiv.innerHTML = fieldsHtml;
        // Ensure the display field is correctly set after rendering
        document.getElementById('selectUserTypeDisplay').value = userType;
    }

    // Initial render
    window.onload = () => {
        // Set the initial user type selection to the first available option for better UX
        const initialType = userTypeMainSelect.options[1]?.value; 
        if (initialType) {
            userTypeMainSelect.value = initialType;
            renderSpecificForm(initialType);
        } else {
            showMessage("অনুগ্রহ করে ডেটা যোগ করার জন্য ব্যবহারকারীর ধরণ নির্বাচন করুন।", "info");
        }
    };
    
    // --- Form Submission Handler ---
    async function handleFormSubmit(event) {
        event.preventDefault();
        
        if (!isAuthReady) {
            showMessage("ত্রুটি: প্রমাণীকরণ প্রক্রিয়া এখনও সম্পূর্ণ হয়নি। অনুগ্রহ করে অপেক্ষা করুন।", "error");
            return;
        }

        const userType = userTypeMainSelect.value;
        if (!userType) {
            showMessage("অনুগ্রহ করে ব্যবহারকারীর ধরণ নির্বাচন করুন।", "error");
            return;
        }

        const form = event.target;
        const formData = new FormData(form);
        const data = {};

        for (const [key, value] of formData.entries()) {
            if (key !== 'passport-photo') { // Exclude file input
                data[key] = value.trim();
            }
        }
        
        // Finalize data structure
        data.userRole = userType;
        data.designation = data.designation || userType; // Use selected role as designation if not specified (for admin roles)
        delete data.selectUserTypeDisplay; // Remove helper display field
        
        const email = data.email;
        const password = data.password;
        delete data.password; // Do NOT save password in Firestore

        if (!email || !password) {
            showMessage("ইমেইল এবং পাসওয়ার্ড আবশ্যিক!", "error");
            return;
        }

        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        
        submitButton.disabled = true;
        submitButton.textContent = 'সেভ হচ্ছে...';
        showMessage("তথ্য ডেটাবেসে সেভ হচ্ছে, অপেক্ষা করুন...", "info");

        try {
            const collectionPath = getCollectionPath(userType);
            if (!collectionPath) throw new Error("অবৈধ ব্যবহারকারীর ধরণ।");

            let userId = null;

            // 1. Create user in Firebase Authentication
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            userId = userCredential.user.uid;

            // 2. Save user details in Firestore
            await db.collection(collectionPath).doc(userId).set({
                ...data,
                uid: userId 
            });
            
            showMessage(`সাফল্য! নতুন ${userType} যোগ করা হয়েছে। Firestore ID: ${userId}`, "success");
            
            // Clear the form and re-render
            form.reset();
            document.getElementById('file-name-display').textContent = 'No file selected';
            renderSpecificForm(userTypeMainSelect.value);

        } catch (error) {
            console.error("Error adding document or creating user: ", error);
            
            // Handle specific Firebase Auth errors
            let userFriendlyMessage = error.message;
            if (error.code === 'auth/email-already-in-use') {
                userFriendlyMessage = 'এই ইমেইল দিয়ে একটি অ্যাকাউন্ট ইতিমধ্যেই আছে।';
            } else if (error.code === 'auth/invalid-email') {
                userFriendlyMessage = 'ইমেইল ফরম্যাট সঠিক নয়।';
            } else if (error.code === 'auth/weak-password') {
                userFriendlyMessage = 'পাসওয়ার্ডটি কমপক্ষে ৬ অক্ষরের হতে হবে।';
            }
            showMessage(`তথ্য সেভ করতে সমস্যা হয়েছে: ${userFriendlyMessage}`, "error");
            
            // If the user was created but saving to Firestore failed, you'd need cleanup logic here.
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Submit form';
        }
    }
    
    // Simple tab change handler (mainly for visual feedback)
    function changeTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-button[onclick="changeTab('${tabName}')"]`).classList.add('active');
        // You would switch content blocks here if you had more tabs
    }
</script>
</body>
</html>
