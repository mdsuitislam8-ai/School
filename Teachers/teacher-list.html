<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>শিক্ষক ও কর্মচারীদের তালিকা</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <style>
        /* Base Styles */
        body { font-family: 'Noto Sans Bengali', sans-serif; background-color: #f4f6f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1300px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; color: #333; }
        .header h1 { font-size: 1.5rem; font-weight: 500; margin: 0; display: flex; align-items: center; }
        .list-card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); padding: 0; }
        
        /* Filter/Control Styles */
        .filter-section { padding: 20px; border-bottom: 1px solid #eee; }
        .filter-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-input { border: 1px solid #ccc; padding: 8px 12px; border-radius: 4px; flex-grow: 1; max-width: 300px; }
        .action-buttons button { background-color: #007bff; color: white; padding: 8px 15px; border-radius: 4px; font-size: 0.9rem; font-weight: 500; transition: background-color 0.2s; }

        /* Table Styles */
        .teacher-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .teacher-table thead th { text-align: left; padding: 12px; background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; font-weight: 600; color: #495057; }
        .teacher-table tbody td { padding: 12px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
        .teacher-table tbody tr:hover { background-color: #f1f7fe; }
        
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background-color: #e0f2fe; display: inline-flex; align-items: center; justify-content: center; color: #007bff; font-weight: 700; font-size: 1rem; }
        .name-cell { font-weight: 500; color: #007bff; }
        .id-cell { display: block; font-size: 0.8rem; color: #6c757d; }
        
        /* Action Button Styling - Combined View/Delete Icons */
        .action-group { display: flex; justify-content: center; gap: 8px; }
        .action-icon { cursor: pointer; padding: 6px; border-radius: 4px; transition: background-color 0.2s; }
        .action-icon:hover { opacity: 0.8; }
        .action-icon.view:hover { background-color: #e0f7fa; color: #0056b3; }
        .action-icon.delete:hover { background-color: #fee2e2; color: #b91c1c; }


        /* Loader Animation */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive Table View (Mobile First: Card View) */
        @media (max-width: 900px) {
            .teacher-table, .teacher-table thead, .teacher-table tbody, .teacher-table th, .teacher-table td, .teacher-table tr { display: block; }
            .teacher-table thead { display: none; }
            .teacher-table tr { margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
            .teacher-table tbody td {
                border-bottom: 1px dotted #dee2e6;
                text-align: right;
                position: relative;
                padding-left: 50%; 
            }
            .teacher-table tbody td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #495057;
            }
            .teacher-table tbody td:last-child { border-bottom: none; }
            .filter-controls { justify-content: space-between; gap: 5px; }
            .filter-input { max-width: 100%; margin-bottom: 10px; }
            .action-buttons { margin-top: 10px; }
            .action-group { justify-content: flex-end; } /* Align icons right in card view */
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.3s ease;
            opacity: 0; pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1; pointer-events: auto;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px;
            max-width: 400px; width: 90%; transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users text-blue-500 mr-2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            শিক্ষকদের তথ্য
        </h1>
        <div class="header-session text-sm text-gray-500">
            মোট শিক্ষক: <span id="teacher-count">...</span>
        </div>
    </header>

    <div class="list-card">
        <div class="filter-section">
            <div class="filter-controls">
                <input type="text" id="teacherFilter" onkeyup="filterTable()" class="filter-input" placeholder="খোঁজ করুন: নাম, আইডি, পদবী...">
                
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <label for="showEntries">Show:</label>
                    <select id="showEntries" onchange="filterTable()" class="border border-gray-300 rounded-md p-1">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="all">All</option>
                    </select>
                </div>
                
                <div class="action-buttons ml-auto flex gap-2">
                    <button onclick="alert('Copy function triggered')">Copy</button>
                    <button onclick="alert('Excel function triggered')">Excel</button>
                    <button onclick="alert('PDF function triggered')">PDF</button>
                    <button class="bg-blue-600" onclick="alert('Visibility function triggered')">Visibility</button>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="teacher-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">S/N</th>
                        <th style="width: 10%;">Photo</th>
                        <th style="width: 25%;">Name, Employee ID</th>
                        <th style="width: 20%;">Designation</th>
                        <th style="width: 25%;">Subject / Joining Date</th>
                        <th style="width: 15%;">Action</th>
                    </tr>
                </thead>
                <tbody id="teachersList">
                    <tr id="loadingRow">
                        <td colspan="6" class="text-center p-8">
                            <div id="loadingIndicator" class="loader"></div>
                            <p class="mt-2 text-gray-600">শিক্ষক তালিকা লোড হচ্ছে...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="emptyMessage" class="hidden text-center p-8 text-gray-500 font-medium">
            কোনো শিক্ষক পাওয়া যায়নি।
        </div>
        
        <div class="p-4 border-t border-gray-100 flex justify-between items-center text-sm text-gray-600">
            <span id="showingEntries">Showing 0 to 0 of 0 entries</span>
            <div class="flex space-x-1">
                <button class="px-3 py-1 border rounded-md" disabled>Previous</button>
                <button class="px-3 py-1 border rounded-md bg-blue-500 text-white">1</button>
                <button class="px-3 py-1 border rounded-md">2</button>
                <button class="px-3 py-1 border rounded-md">Next</button>
            </div>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="text-xl font-bold text-red-600 mb-3 flex items-center">
            <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> ডিলিট নিশ্চিত করুন
        </h3>
        <p id="confirmMessage" class="text-gray-700 mb-6">আপনি কি নিশ্চিত যে আপনি এই শিক্ষককে ডিলিট করতে চান? এই প্রক্রিয়াটি অপরিবর্তনীয়।</p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeModal('confirmModal')" 
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                বাতিল
            </button>
            <button id="confirmDeleteButton" 
                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                ডিলিট করুন
            </button>
        </div>
    </div>
</div>

<script>
    // --- Firebase Global Setup ---
    const firebaseConfig = {
        apiKey: "AIzaSyAjoRYAXQa4J43L4oLmHmUoK7ZqMKCdrxI",
        projectId: "programme-7eb45",
        // Add other necessary config fields if needed
    };

    const appId = firebaseConfig.projectId; 
    let db;
    let allTeachers = []; 

    // --- DOM Elements ---
    const teachersListBody = document.getElementById('teachersList');
    const loadingRow = document.getElementById('loadingRow');
    const emptyMessage = document.getElementById('emptyMessage');
    const showingEntriesSpan = document.getElementById('showingEntries');
    const teacherFilterInput = document.getElementById('teacherFilter');
    const showEntriesSelect = document.getElementById('showEntries');
    const teacherCountElement = document.getElementById('teacher-count');
    
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');

    const COLLECTION_PATH = `/artifacts/${appId}/public/data/teachers`;

    // --- Firebase Initialization ---
    try {
        const app = firebase.initializeApp(firebaseConfig);
        db = app.firestore();
        fetchTeachers();
        
    } catch (error) {
        console.error("Firebase Initialization Failed:", error);
        loadingRow.innerHTML = `<td colspan="6" class="text-center text-red-600 p-8">ডেটাবেস সংযোগে সমস্যা হয়েছে।</td>`;
    }


    // --- Data Management Functions ---

    function renderTeachers(teachers) {
        teachersListBody.innerHTML = '';
        loadingRow.classList.add('hidden');
        emptyMessage.classList.add('hidden');

        teacherCountElement.textContent = allTeachers.length;

        const entriesPerPage = showEntriesSelect.value === 'all' ? teachers.length : parseInt(showEntriesSelect.value);
        const displayTeachers = teachers.slice(0, entriesPerPage);
        
        if (displayTeachers.length === 0) {
            emptyMessage.classList.remove('hidden');
            return;
        }

        displayTeachers.forEach((teacher, index) => {
            const row = document.createElement('tr');
            
            const fullName = teacher.fullName || 'N/A';
            const initial = fullName ? fullName[0].toUpperCase() : '?';
            const designation = (teacher.designation || teacher.userRole || 'N/A').replace(/_/g, ' ');
            const subjectOrDept = teacher.subject || teacher.department || 'N/A';
            // Use try-catch for date conversion if 'doj' might be an invalid timestamp
            let joiningDate = 'N/A';
            try {
                if (teacher.doj) {
                    joiningDate = new Date(teacher.doj).toLocaleDateString('bn-BD');
                }
            } catch (e) { console.error("Invalid DOJ format:", teacher.doj); }

            const teacherId = teacher.uid;

            row.innerHTML = `
                <td data-label="ক্রমিক নং">${index + 1}</td>
                <td data-label="ছবি">
                    <div class="profile-pic">${initial}</div>
                </td>
                <td data-label="নাম, আইডি">
                    <span class="name-cell">${fullName}</span>
                    <span class="id-cell">ID NO: ${teacher.employeeId || teacherId.substring(0, 8)}</span>
                </td>
                <td data-label="পদবী">
                    ${designation.charAt(0).toUpperCase() + designation.slice(1)}
                </td>
                <td data-label="বিষয় / যোগদানের তারিখ">
                    ${subjectOrDept}<br/>
                    <span class="id-cell">DOJ: ${joiningDate}</span>
                </td>
                <td data-label="অ্যাকশন">
                    <div class="action-group">
                        <i data-lucide="eye" 
                            class="action-icon view text-blue-500 w-5 h-5" 
                            title="বিস্তারিত দেখুন"
                            onclick="handleAction('view', '${teacherId}')">
                        </i>
                        <i data-lucide="trash-2" 
                            class="action-icon delete text-red-500 w-5 h-5" 
                            title="মুছে ফেলুন"
                            onclick="showConfirmationModal('${teacherId}', '${fullName}')">
                        </i>
                    </div>
                </td>
            `;
            teachersListBody.appendChild(row);
        });

        // Update footer summary
        showingEntriesSpan.textContent = `Showing 1 to ${displayTeachers.length} of ${teachers.length} entries`;
        // Re-create icons for newly added HTML
        lucide.createIcons(); 
    }

    function fetchTeachers() {
        if (!db) return;
        
        loadingRow.classList.remove('hidden');
        teachersListBody.innerHTML = '';

        try {
            db.collection(COLLECTION_PATH).onSnapshot(snapshot => {
                allTeachers = [];
                snapshot.forEach(doc => {
                    allTeachers.push({ uid: doc.id, ...doc.data() });
                });
                filterTable();
            }, error => {
                console.error("Error fetching teachers:", error);
                loadingRow.classList.add('hidden');
                teachersListBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-600 p-8">ডেটা লোড করতে ব্যর্থ: ${error.message}</td></tr>`;
            });
        } catch (e) {
             console.error("Error setting up onSnapshot:", e);
             loadingRow.classList.add('hidden');
             teachersListBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-600 p-8">ডেটাবেস সংযোগে সমস্যা।</td></tr>`;
        }
    }
    
    function filterTable() {
        const filterText = teacherFilterInput.value.toLowerCase();
        
        const filteredTeachers = allTeachers.filter(teacher => {
            const dateStr = teacher.doj ? new Date(teacher.doj).toLocaleDateString('bn-BD') : '';
            return (teacher.fullName && teacher.fullName.toLowerCase().includes(filterText)) ||
                   (teacher.employeeId && teacher.employeeId.toLowerCase().includes(filterText)) ||
                   (teacher.email && teacher.email.toLowerCase().includes(filterText)) ||
                   (teacher.designation && teacher.designation.toLowerCase().includes(filterText)) ||
                   (teacher.subject && teacher.subject.toLowerCase().includes(filterText)) ||
                   dateStr.includes(filterText);
        });

        renderTeachers(filteredTeachers);
    }
    
    // --- Modal Functions ---

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function showConfirmationModal(teacherId, teacherName) {
        confirmMessage.innerHTML = `আপনি কি নিশ্চিত যে আপনি শিক্ষক <b>${teacherName}</b> (ID: ${teacherId.substring(0, 8)}) কে ডিলিট করতে চান? এই প্রক্রিয়াটি অপরিবর্তনীয়।`;
        
        // Attach the specific delete function to the confirmation button
        confirmDeleteButton.onclick = () => {
            closeModal('confirmModal');
            deleteTeacher(teacherId, teacherName);
        };
        
        confirmModal.classList.add('active');
        lucide.createIcons(); // Re-render icons if necessary
    }


    // --- Action Functions ---

    function handleAction(actionType, teacherId) {
        if (actionType === 'view') {
            window.location.href = `tdetails.html?teacherId=${teacherId}`; 
        } else {
            // Placeholder for other actions if needed
            alert(`Action '${actionType}' for Teacher ID: ${teacherId}`);
        }
    }

    async function deleteTeacher(teacherId, teacherName) {
        if (!db) {
            alert('ত্রুটি: ডেটাবেস সংযোগ উপলব্ধ নয়।');
            return;
        }

        // Simple feedback before deletion
        alert(`শিক্ষক ${teacherName} ডিলিট প্রক্রিয়া শুরু হচ্ছে...`);

        try {
            // Delete the document from the 'teachers' collection
            await db.collection(COLLECTION_PATH).doc(teacherId).delete();

            // Success feedback
            alert(`সফল! 🎉 শিক্ষক ${teacherName} এর ডেটা সফলভাবে ডিলিট করা হয়েছে।`);
            
            // The onSnapshot listener will automatically re-render the list.

        } catch (error) {
            console.error("Delete Operation Failed:", error);
            alert(`ডিলিট ত্রুটি 🛑: ডেটা ডিলিট করতে ব্যর্থ। সম্ভবত আপনার Firebase Security Rules ডিলিট করার অনুমতি দিচ্ছে না। ত্রুটি: ${error.message}`);
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        teacherFilterInput.addEventListener('keyup', filterTable);
        showEntriesSelect.addEventListener('change', filterTable);
    });
</script>
</body>
</html>